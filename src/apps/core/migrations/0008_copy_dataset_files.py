# Generated by Django 3.2.18 on 2023-04-26 12:41

from collections import Counter
from django.db import migrations

def dataset_to_fileset(apps, schema_editor):
    """Copy Dataset files to FileSet."""
    FileSet = apps.get_model("core", "FileSet")
    Dataset = apps.get_model("core", "Dataset")
    for dataset in Dataset.objects.filter(files__isnull=False):
        existing_storages = (
            dataset.files.order_by("file_storage")
            .values_list("file_storage", flat=True).distinct()
        )
        if len(existing_storages) > 1:
            raise ValueError(f"Dataset {dataset.id} has multiple FileStorages: {existing_storages}.")

        file_storage, created = FileSet.objects.get_or_create(
            dataset=dataset,
            file_storage=dataset.files.first().file_storage,
        )
        file_storage.files.add(*dataset.files.all())

def fileset_to_dataset(apps, schema_editor):
    """Copy FileSet files to Dataset."""
    FileSet = apps.get_model("core", "FileSet")
    for file_set in FileSet.objects.filter(files__isnull=False):
        file_set.dataset.files.add(*file_set.files.all())



class Migration(migrations.Migration):

    dependencies = [
        ('core', '0007_fileset'),
    ]

    operations = [
        migrations.RunPython(dataset_to_fileset, fileset_to_dataset)
    ]

# Generated by Django 4.2.16 on 2024-10-03 08:34

from django.db import migrations, models

def set_pid_attributes(apps, schema_editor):
    catalog_model = apps.get_model("core.DataCatalog")
    managed_catalogs = (
        catalog_model.objects.filter(harvested=False)
        .exclude(allowed_pid_types__contains=["external"])
    )
    urn_catalogs = managed_catalogs.filter(allowed_pid_types__contains=["URN"])
    for catalog in urn_catalogs:
        catalog.datasets.filter(state="published").update(pid_generated_by_fairdata=True)
        catalog.datasets.filter(persistent_identifier__startswith="urn:").update(
            generate_pid_on_publish="URN"
        )

    doi_catalogs = managed_catalogs.filter(allowed_pid_types__contains=["DOI"])
    for catalog in doi_catalogs:
        catalog.datasets.filter(state="published").update(pid_generated_by_fairdata=True)
        catalog.datasets.filter(persistent_identifier__startswith="doi:").update(
            generate_pid_on_publish="DOI"
        )

class Migration(migrations.Migration):

    dependencies = [
        ('core', '0026_datacatalog_allowed_pid_types_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='dataset',
            name='pid_generated_by_fairdata',
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name='historicaldataset',
            name='pid_generated_by_fairdata',
            field=models.BooleanField(default=False),
        ),
        migrations.RunPython(set_pid_attributes, migrations.RunPython.noop)
    ]
